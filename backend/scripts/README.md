# Скрипт отправки предложений на почту (опционально)

## Описание

**Примечание**: Скрипт теперь **опционален**, так как отправка email происходит автоматически сразу после получения предложения через API endpoint. Этот скрипт может использоваться для периодической проверки и отправки накопленных предложений в случае, если автоматическая отправка не сработала.

Скрипт `send_feedback_email.py` отправляет новые предложения по улучшению приложения на почту `nwisdom@mail.ru` используя SendGrid API.

**Преимущества SendGrid:**
- Не требует пароля от почтового ящика
- Использует только API ключ для аутентификации
- Бесплатный тариф: 100 писем в день
- Высокая доставляемость писем

## Настройка

### 1. Регистрация в SendGrid

1. Зарегистрируйтесь на [SendGrid](https://sendgrid.com/) (бесплатно)
2. Перейдите в Settings → API Keys
3. Создайте новый API ключ с правами "Mail Send"
4. Скопируйте созданный API ключ

### 2. Настройка Sender Identity (ОБЯЗАТЕЛЬНО!)

**ВАЖНО**: Для использования SendGrid API необходимо настроить Domain Authentication. Single Sender Verification НЕ работает с API.

#### Вариант 1: Domain Authentication (Рекомендуется)

1. Войдите в [SendGrid Dashboard](https://app.sendgrid.com/)
2. Перейдите в **Settings** → **Sender Authentication** → **Domain Authentication**
3. Нажмите **Authenticate Your Domain**
4. Введите ваш домен (например, `yourdomain.com`)
5. Выберите поддомен для аутентификации (например, `mail.yourdomain.com`)
6. Добавьте DNS записи, которые SendGrid предоставит, в настройки вашего домена
7. После верификации вы сможете отправлять email с любого адреса на этом домене

#### Вариант 2: Использование верифицированного email (Временное решение)

Если у вас нет собственного домена, вы можете временно использовать ваш реальный email адрес:

1. Войдите в [SendGrid Dashboard](https://app.sendgrid.com/)
2. Перейдите в **Settings** → **Sender Authentication** → **Single Sender Verification**
3. Создайте новый Sender с вашим реальным email адресом
4. Проверьте email и подтвердите адрес
5. **Однако**: Single Sender Verification имеет ограничения и может не работать с API в некоторых случаях

**Рекомендация**: Используйте Domain Authentication для production использования.

### 3. Переменные окружения

Создайте файл `.env` в директории `backend/` или установите следующие переменные окружения:

```bash
SENDGRID_API_KEY=SG.xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
SENDGRID_FROM_EMAIL=your-verified-email@yourdomain.com  # ОБЯЗАТЕЛЬНО: верифицированный email адрес
```

**Важно:** 
- Адрес получателя (`nwisdom@mail.ru`) захардкожен в скрипте и не доступен через API для безопасности
- `SENDGRID_FROM_EMAIL` должен быть верифицированным адресом в SendGrid (через Domain Authentication)
- API ключ SendGrid не является паролем и может быть отозван в любой момент через веб-интерфейс

### 2. Запуск скрипта

#### Вручную:
```bash
cd backend
python scripts/send_feedback_email.py
```

#### Через cron (Linux/Mac):
Добавьте в crontab для запуска каждые 5 минут:
```bash
*/5 * * * * cd /path/to/backend && python scripts/send_feedback_email.py >> /var/log/feedback_email.log 2>&1
```

#### Через планировщик задач Windows:
1. Откройте "Планировщик заданий"
2. Создайте новое задание
3. Установите триггер (например, каждые 5 минут)
4. В действии укажите: `python.exe` с аргументом `D:\path\to\backend\scripts\send_feedback_email.py`

## Как это работает

1. Скрипт читает файл `backend/app/data/feedback.json`
2. Находит предложения, которые еще не были отправлены (сверяет с `sent_feedback.json`)
3. Отправляет все новые предложения одним письмом на почту
4. Помечает отправленные предложения в `sent_feedback.json`

**Важно**: В нормальном режиме работы каждое предложение отправляется автоматически сразу после получения через API. Этот скрипт нужен только для:
- Резервной отправки, если автоматическая отправка не сработала
- Отправки накопленных предложений, если они были созданы до внедрения автоматической отправки

## Структура данных

Предложения хранятся в `feedback.json` в следующем формате:

```json
{
  "feedback_texts": {
    "1": "Текст первого предложения",
    "2": "Текст второго предложения"
  },
  "feedback_metadata": {
    "1": {
      "tab_name": "Скринер облигаций",
      "timestamp": "2024-01-01T12:00:00"
    },
    "2": {
      "tab_name": "Мой портфель",
      "timestamp": "2024-01-01T13:00:00"
    }
  }
}
```

Текст предложения и метаданные хранятся отдельно, как требуется.

## Установка зависимостей

Убедитесь, что установлен пакет `sendgrid`:

```bash
pip install sendgrid
```

Или установите все зависимости из `requirements.txt`:

```bash
pip install -r requirements.txt
```

## Безопасность

- Адрес получателя (`nwisdom@mail.ru`) захардкожен в скрипте и не доступен через API
- SendGrid API ключ должен храниться в переменных окружения, а не в коде
- Файл `.env` должен быть добавлен в `.gitignore`
- API ключ можно отозвать в любой момент через веб-интерфейс SendGrid
- SendGrid не требует пароля от почтового ящика - используется только API ключ
